<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Exam - EduAI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>
    
    <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
    <nav class="sidebar">
        <a href="/" class="logo">EduAI</a>
        <ul class="nav-links">
            <li><a href="/teacher_dashboard">Dashboard</a></li>
            <li><a href="/create_exam">Create Exam</a></li>
            <li><a href="/view_answers">View Answers</a></li>
            <li><a href="/view_results">View Results</a></li>
            <li><a href="/teacher/profile">Profile</a></li>
            <li><a href="/logout">Logout</a></li>
        </ul>
    </nav>
    
    <main>
        <section class="form-section admin-form-section">
            <h1>Edit Exam: {{ exam.exam_name }}</h1>
            <p>Welcome, {{ name }}!</p>
            
            <div class="flash-messages">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="flash {{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>

            <div style="margin-bottom: 2rem; padding: 1rem; background: rgba(72, 52, 212, 0.1); border-radius: 8px; border: 1px solid rgba(72, 52, 212, 0.2);">
                <h3 style="color: #4834d4; margin-bottom: 0.5rem;">‚úèÔ∏è Edit Exam Details</h3>
                <p><strong>Course:</strong> {{ exam.course_name }} | <strong>Semester:</strong> {{ exam.semester_name }} | <strong>Subject:</strong> {{ exam.subject_name }}</p>
            </div>

            <form method="POST" action="{{ url_for('edit_exam', exam_id=exam.exam_id) }}" class="form-group">
                <input type="hidden" name="course_id" value="{{ exam.course_id }}">
                <input type="hidden" name="semester_id" value="{{ exam.semester_id }}">
                <input type="hidden" name="subject_id" value="{{ exam.subject_id }}">
                
                <fieldset style="border: 1px solid rgba(72, 52, 212, 0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <legend style="color: #4834d4; font-weight: bold; padding: 0 0.5rem;">Basic Information</legend>
                    
                    <div class="form-field">
                        <label for="exam_name">Exam Name *</label>
                        <input type="text" id="exam_name" name="exam_name" value="{{ exam.exam_name }}" required>
                    </div>
                    
                    <div class="form-field">
                        <label for="topic">Topic *</label>
                        <input type="text" id="topic" name="topic" value="{{ exam.topic }}" required>
                    </div>
                </fieldset>

                <fieldset style="border: 1px solid rgba(72, 52, 212, 0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <legend style="color: #4834d4; font-weight: bold; padding: 0 0.5rem;">Marking Criteria</legend>
                    
                    <div class="form-field">
                        <label for="min_passing_percentage">Minimum Passing Percentage *</label>
                        <input type="number" id="min_passing_percentage" name="min_passing_percentage" value="{{ (exam.min_marks / exam.max_marks * 100) | round(1) }}" min="0" max="100" step="0.1" required>
                        <small style="color: #666; display: block; margin-top: 0.25rem;">Students need this percentage to pass the exam</small>
                    </div>
                    
                    <div class="form-field">
                        <label for="min_marks">Minimum Marks (Auto-calculated)</label>
                        <input type="number" id="min_marks" name="min_marks" value="{{ exam.min_marks }}" readonly style="background: rgba(248, 249, 250, 0.8);">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">Current maximum marks: {{ exam.max_marks }}</small>
                    </div>
                </fieldset>

                <fieldset style="border: 1px solid rgba(72, 52, 212, 0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <legend style="color: #4834d4; font-weight: bold; padding: 0 0.5rem;">Exam Schedule</legend>
                    
                    <div class="form-field">
                        <label for="exam_date">Exam Date *</label>
                        <input type="date" id="exam_date" name="exam_date" value="{{ exam.exam_date }}" required>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-field">
                            <label for="start_time">Start Time *</label>
                            <input type="time" id="start_time" name="start_time" value="{{ exam.start_time | strftime('%H:%M') }}" required>
                        </div>
                        
                        <div class="form-field">
                            <label for="end_time">End Time *</label>
                            <input type="time" id="end_time" name="end_time" value="{{ exam.end_time | strftime('%H:%M') }}" required>
                        </div>
                    </div>
                </fieldset>

                <h2>Edit Question Marks</h2>
                {% if questions %}
                    <div style="overflow-x: auto; margin-bottom: 1rem;">
                        <table>
                            <thead>
                                <tr>
                                    <th style="min-width: 300px;">Question</th>
                                    <th style="min-width: 200px;">Model Answer</th>
                                    <th style="min-width: 150px;">Maximum Marks</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for q in questions %}
                                <tr>
                                    <td style="max-width: 300px; word-wrap: break-word;">{{ q.question_text }}</td>
                                    <td style="max-width: 200px; word-wrap: break-word;">{{ q.model_answer }}</td>
                                    <td>
                                        <input type="number" name="marks_{{ q.question_id }}" value="{{ q.max_score }}" min="0" step="0.1" required style="width: 80px; padding: 0.5rem;">
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 2rem; background: rgba(255, 107, 107, 0.1); border-radius: 8px; border: 1px solid rgba(255, 107, 107, 0.2);">
                        <span style="font-size: 2rem; display: block; margin-bottom: 1rem;">‚ùì</span>
                        <h4 style="color: #e74c3c;">No Questions Found</h4>
                        <p style="color: #666;">This exam doesn't have any questions associated with it.</p>
                    </div>
                {% endif %}
                
                <div class="form-navigation">
                    <button type="submit" name="update_exam" class="submit-btn">Update Exam</button>
                    <a href="{{ url_for('teacher_dashboard') }}" style="background: linear-gradient(45deg, #6c757d, #5a6268); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: 8px; text-decoration: none; display: inline-block; margin-left: 1rem;">Cancel</a>
                </div>
            </form>
                
            {% if errors %}
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(255, 107, 107, 0.1); border-radius: 8px; border: 1px solid rgba(255, 107, 107, 0.3);">
                    <h4 style="color: #e74c3c; margin-bottom: 0.5rem;">‚ùå Validation Errors</h4>
                    {% for error in errors %}
                        <p style="color: #e74c3c; margin: 0.25rem 0;">‚Ä¢ {{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}

            <div style="margin-top: 2rem; padding: 1rem; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border: 1px solid rgba(255, 193, 7, 0.3);">
                <h4 style="color: #856404; margin-bottom: 0.5rem;">üí° Editing Tips</h4>
                <ul style="color: #856404; margin: 0; padding-left: 1.5rem;">
                    <li>Changes to question marks will recalculate the total exam marks automatically</li>
                    <li>Ensure exam timing allows sufficient time for all questions</li>
                    <li>Review all changes before saving the exam</li>
                </ul>
            </div>
        </section>
    </main>
    
    <footer>
        <p>¬© 2025 EduAI - Smart Question Answer System. All rights reserved.</p>
    </footer>

    <script>
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('closed');
            document.querySelector('main').classList.toggle('full-width');
        }

        // Update min_marks dynamically based on min_passing_percentage
        document.getElementById('min_passing_percentage')?.addEventListener('input', function() {
            const percentage = parseFloat(this.value);
            const maxMarks = parseFloat({{ exam.max_marks|tojson }});
            const minMarksInput = document.getElementById('min_marks');
            if (!isNaN(percentage) && !isNaN(maxMarks)) {
                minMarksInput.value = Math.round((percentage / 100) * maxMarks * 10) / 10;
            } else {
                minMarksInput.value = 0;
            }
        });

        // Set minimum date to today for future exams
        document.addEventListener('DOMContentLoaded', function() {
            const examDateInput = document.getElementById('exam_date');
            if (examDateInput) {
                const today = new Date().toISOString().split('T')[0];
                examDateInput.setAttribute('min', today);
            }
        });
    </script>
</body>
</html>